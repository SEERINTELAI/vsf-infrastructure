---
# deploy-prometheus-stack.yml
# Deploy kube-prometheus-stack to K3s cluster (Task 114)
#
# Usage:
#   ansible-playbook -i inventory/vsf.yml monitoring/deploy-prometheus-stack.yml
#
# This deploys:
#   - Prometheus Server
#   - Alertmanager
#   - node-exporter (DaemonSet)
#   - kube-state-metrics
#   - Prometheus Operator (for ServiceMonitors)

- name: Deploy Prometheus Stack
  hosts: control_plane[0]
  become: true
  vars:
    helm_repo_name: prometheus-community
    helm_repo_url: https://prometheus-community.github.io/helm-charts
    release_name: prometheus
    namespace: monitoring
    
    # Storage configuration
    prometheus_retention: 15d
    prometheus_storage_size: 50Gi
    alertmanager_storage_size: 5Gi
    
    # Resource limits
    prometheus_memory_limit: 4Gi
    prometheus_cpu_limit: 2
    alertmanager_memory_limit: 256Mi
    
  tasks:
    - name: Ensure Helm is installed
      block:
        - name: Check if Helm is installed
          command: helm version --short
          register: helm_check
          changed_when: false
          failed_when: false
        
        - name: Install Helm if not present
          when: helm_check.rc != 0
          shell: |
            curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          args:
            creates: /usr/local/bin/helm
    
    - name: Add Prometheus Helm repository
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      command: helm repo add {{ helm_repo_name }} {{ helm_repo_url }}
      register: repo_add
      changed_when: "'has been added' in repo_add.stdout"
      failed_when: false
    
    - name: Update Helm repositories
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      command: helm repo update
      changed_when: false
    
    - name: Create monitoring namespace
      command: k3s kubectl create namespace {{ namespace }} --dry-run=client -o yaml
      register: ns_yaml
      changed_when: false
    
    - name: Apply monitoring namespace
      command: k3s kubectl apply -f -
      args:
        stdin: "{{ ns_yaml.stdout }}"
    
    - name: Label monitoring namespace
      command: >
        k3s kubectl label namespace {{ namespace }}
        vsf/component=monitoring
        --overwrite
    
    - name: Create Prometheus values file
      copy:
        dest: /tmp/prometheus-values.yaml
        mode: '0644'
        content: |
          # kube-prometheus-stack values for VSF
          # Generated by Ansible deploy-prometheus-stack.yml
          
          # Global settings
          fullnameOverride: prometheus
          
          # Prometheus Server
          prometheus:
            prometheusSpec:
              retention: {{ prometheus_retention }}
              
              # Resource limits
              resources:
                limits:
                  cpu: {{ prometheus_cpu_limit }}
                  memory: {{ prometheus_memory_limit }}
                requests:
                  cpu: 500m
                  memory: 1Gi
              
              # Storage
              storageSpec:
                volumeClaimTemplate:
                  spec:
                    accessModes: ["ReadWriteOnce"]
                    resources:
                      requests:
                        storage: {{ prometheus_storage_size }}
              
              # Scrape interval
              scrapeInterval: 15s
              evaluationInterval: 15s
              
              # Additional scrape configs for custom exporters
              additionalScrapeConfigs:
                # Mock DCGM Exporter (GPU metrics)
                - job_name: 'mock-dcgm-exporter'
                  kubernetes_sd_configs:
                    - role: pod
                      namespaces:
                        names:
                          - gpu-monitoring
                  relabel_configs:
                    - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
                      action: keep
                      regex: mock-dcgm-exporter
                    - source_labels: [__meta_kubernetes_pod_ip]
                      action: replace
                      target_label: __address__
                      regex: (.+)
                      replacement: ${1}:9400
                
                # Synthetic Power Exporter
                - job_name: 'synthetic-power-exporter'
                  kubernetes_sd_configs:
                    - role: pod
                      namespaces:
                        names:
                          - power-monitoring
                  relabel_configs:
                    - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
                      action: keep
                      regex: synthetic-power-exporter
                    - source_labels: [__meta_kubernetes_pod_ip]
                      action: replace
                      target_label: __address__
                      regex: (.+)
                      replacement: ${1}:9100
          
          # Alertmanager
          alertmanager:
            alertmanagerSpec:
              resources:
                limits:
                  cpu: 200m
                  memory: {{ alertmanager_memory_limit }}
                requests:
                  cpu: 50m
                  memory: 64Mi
              
              storage:
                volumeClaimTemplate:
                  spec:
                    accessModes: ["ReadWriteOnce"]
                    resources:
                      requests:
                        storage: {{ alertmanager_storage_size }}
          
          # Node Exporter (DaemonSet)
          nodeExporter:
            enabled: true
          
          prometheus-node-exporter:
            resources:
              limits:
                cpu: 200m
                memory: 128Mi
              requests:
                cpu: 50m
                memory: 32Mi
          
          # kube-state-metrics
          kubeStateMetrics:
            enabled: true
          
          kube-state-metrics:
            resources:
              limits:
                cpu: 200m
                memory: 256Mi
              requests:
                cpu: 50m
                memory: 64Mi
          
          # Grafana (will deploy separately for more control)
          grafana:
            enabled: false
          
          # Prometheus Operator
          prometheusOperator:
            resources:
              limits:
                cpu: 200m
                memory: 256Mi
              requests:
                cpu: 50m
                memory: 64Mi
          
          # Default rules (optional - disable for now, we'll add custom)
          defaultRules:
            create: true
            rules:
              alertmanager: true
              etcd: false  # K3s uses embedded etcd differently
              configReloaders: true
              general: true
              k8s: true
              kubeApiserverAvailability: true
              kubeApiserverBurnrate: true
              kubeApiserverHistogram: true
              kubeApiserverSlos: true
              kubeControllerManager: false  # K3s bundles this
              kubelet: true
              kubeProxy: false  # K3s bundles this
              kubePrometheusGeneral: true
              kubePrometheusNodeRecording: true
              kubernetesApps: true
              kubernetesResources: true
              kubernetesStorage: true
              kubernetesSystem: true
              kubeSchedulerAlerting: false  # K3s bundles this
              kubeSchedulerRecording: false
              kubeStateMetrics: true
              network: true
              node: true
              nodeExporterAlerting: true
              nodeExporterRecording: true
              prometheus: true
              prometheusOperator: true
    
    - name: Deploy kube-prometheus-stack
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      command: >
        helm upgrade --install {{ release_name }}
        {{ helm_repo_name }}/kube-prometheus-stack
        --namespace {{ namespace }}
        --values /tmp/prometheus-values.yaml
        --wait
        --timeout 10m
      register: helm_install
    
    - name: Display Helm output
      debug:
        msg: "{{ helm_install.stdout_lines }}"


- name: Validate Prometheus Stack deployment
  hosts: control_plane[0]
  become: true
  vars:
    namespace: monitoring
    
  tasks:
    - name: Wait for Prometheus to be ready
      command: >
        k3s kubectl rollout status statefulset/prometheus-prometheus
        -n {{ namespace }} --timeout=300s
      register: prometheus_rollout
      retries: 3
      delay: 30
      until: prometheus_rollout.rc == 0
    
    - name: Wait for Alertmanager to be ready
      command: >
        k3s kubectl rollout status statefulset/alertmanager-prometheus-alertmanager
        -n {{ namespace }} --timeout=120s
      register: alertmanager_rollout
      retries: 3
      delay: 10
      until: alertmanager_rollout.rc == 0
      failed_when: false  # Alertmanager is optional
    
    - name: Get all monitoring pods
      command: k3s kubectl get pods -n {{ namespace }} -o wide
      register: monitoring_pods
      changed_when: false
    
    - name: Display monitoring pods
      debug:
        msg: "{{ monitoring_pods.stdout_lines }}"
    
    - name: Get Prometheus service
      command: k3s kubectl get svc -n {{ namespace }} -l app.kubernetes.io/name=prometheus
      register: prometheus_svc
      changed_when: false
    
    - name: Display Prometheus service
      debug:
        msg: "{{ prometheus_svc.stdout_lines }}"
    
    - name: Verify Prometheus is scraping targets
      shell: |
        POD=$(k3s kubectl get pods -n {{ namespace }} -l app.kubernetes.io/name=prometheus -o jsonpath='{.items[0].metadata.name}')
        k3s kubectl exec -n {{ namespace }} $POD -c prometheus -- wget -qO- http://localhost:9090/api/v1/targets | head -100
      register: targets
      changed_when: false
      failed_when: false
    
    - name: Display scrape targets (first 100 chars)
      debug:
        msg: "{{ targets.stdout[:500] if targets.stdout else 'No targets yet' }}"
    
    - name: Deployment summary
      debug:
        msg: |
          ========================================
          Prometheus Stack Deployment Complete
          ========================================
          Namespace: {{ namespace }}
          
          Components:
          - Prometheus Server: StatefulSet
          - Alertmanager: StatefulSet
          - node-exporter: DaemonSet
          - kube-state-metrics: Deployment
          - Prometheus Operator: Deployment
          
          Pods:
          {{ monitoring_pods.stdout }}
          
          Access:
          - Prometheus: kubectl port-forward svc/prometheus-prometheus 9090:9090 -n {{ namespace }}
          - Alertmanager: kubectl port-forward svc/prometheus-alertmanager 9093:9093 -n {{ namespace }}
          
          Next Steps:
          1. Deploy Grafana dashboards (Task 117)
          2. Configure custom alerts (Task 118)
          ========================================
