---
# join-workers.yml
# Join worker nodes to K3s cluster
#
# Usage:
#   # Join all workers:
#   ansible-playbook -i inventory/vsf.yml k3s/join-workers.yml
#
#   # Join specific group:
#   ansible-playbook -i inventory/vsf.yml k3s/join-workers.yml -l workers_batch_1
#   ansible-playbook -i inventory/vsf.yml k3s/join-workers.yml -l workers_batch_2
#   ansible-playbook -i inventory/vsf.yml k3s/join-workers.yml -l gpu_workers
#
# Prerequisites:
#   - K3s control plane deployed (Task 105)
#   - Calico CNI installed (Task 106)

- name: Get K3s join token from control plane
  hosts: control_plane[0]
  become: true
  tasks:
    - name: Read K3s node token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token_file
    
    - name: Set token fact
      set_fact:
        k3s_node_token: "{{ k3s_token_file.content | b64decode | trim }}"
    
    - name: Get control plane endpoint
      set_fact:
        k3s_server_url: "https://{{ ansible_host }}:6443"


- name: Join standard worker nodes
  hosts: workers
  become: true
  serial: 5  # Join 5 at a time to avoid overwhelming the cluster
  vars:
    k3s_version: "{{ hostvars[groups['control_plane'][0]]['k3s_version'] | default('v1.29.0+k3s1') }}"
    control_plane_host: "{{ groups['control_plane'][0] }}"
    
  tasks:
    - name: Get token from control plane
      set_fact:
        k3s_token: "{{ hostvars[control_plane_host]['k3s_node_token'] }}"
        k3s_url: "{{ hostvars[control_plane_host]['k3s_server_url'] }}"
    
    - name: Check if K3s is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_binary
    
    - name: Install K3s agent
      when: not k3s_binary.stat.exists
      shell: |
        curl -sfL https://get.k3s.io | \
          INSTALL_K3S_VERSION="{{ k3s_version }}" \
          K3S_URL="{{ k3s_url }}" \
          K3S_TOKEN="{{ k3s_token }}" \
          sh -s - agent
      args:
        creates: /usr/local/bin/k3s
    
    - name: Wait for k3s-agent service to start
      systemd:
        name: k3s-agent
        state: started
        enabled: true
      register: k3s_agent_service
    
    - name: Wait for node to be registered
      delegate_to: "{{ control_plane_host }}"
      command: k3s kubectl get node {{ inventory_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      register: node_ready
      until: node_ready.stdout == "True"
      retries: 30
      delay: 10
      changed_when: false
    
    - name: Apply node labels
      delegate_to: "{{ control_plane_host }}"
      command: "k3s kubectl label node {{ inventory_hostname }} {{ item }} --overwrite"
      loop: "{{ node_labels | default([]) }}"
      changed_when: true


- name: Join GPU worker nodes
  hosts: gpu_workers
  become: true
  serial: 4  # Join 4 GPU nodes at a time
  vars:
    k3s_version: "{{ hostvars[groups['control_plane'][0]]['k3s_version'] | default('v1.29.0+k3s1') }}"
    control_plane_host: "{{ groups['control_plane'][0] }}"
    
  tasks:
    - name: Get token from control plane
      set_fact:
        k3s_token: "{{ hostvars[control_plane_host]['k3s_node_token'] }}"
        k3s_url: "{{ hostvars[control_plane_host]['k3s_server_url'] }}"
    
    - name: Check if K3s is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_binary
    
    - name: Install K3s agent on GPU node
      when: not k3s_binary.stat.exists
      shell: |
        curl -sfL https://get.k3s.io | \
          INSTALL_K3S_VERSION="{{ k3s_version }}" \
          K3S_URL="{{ k3s_url }}" \
          K3S_TOKEN="{{ k3s_token }}" \
          sh -s - agent
      args:
        creates: /usr/local/bin/k3s
    
    - name: Wait for k3s-agent service to start
      systemd:
        name: k3s-agent
        state: started
        enabled: true
      register: k3s_agent_service
    
    - name: Wait for node to be registered
      delegate_to: "{{ control_plane_host }}"
      command: k3s kubectl get node {{ inventory_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      register: node_ready
      until: node_ready.stdout == "True"
      retries: 30
      delay: 10
      changed_when: false
    
    - name: Apply node labels
      delegate_to: "{{ control_plane_host }}"
      command: "k3s kubectl label node {{ inventory_hostname }} {{ item }} --overwrite"
      loop: "{{ node_labels | default([]) }}"
      changed_when: true
    
    - name: Apply GPU taints
      delegate_to: "{{ control_plane_host }}"
      command: "k3s kubectl taint node {{ inventory_hostname }} {{ item }} --overwrite"
      loop: "{{ node_taints | default([]) }}"
      changed_when: true
      when: node_taints is defined


- name: Validate cluster state
  hosts: control_plane[0]
  become: true
  tasks:
    - name: Get all nodes
      command: k3s kubectl get nodes -o wide
      register: all_nodes
      changed_when: false
    
    - name: Display cluster nodes
      debug:
        msg: "{{ all_nodes.stdout_lines }}"
    
    - name: Count Ready nodes
      command: k3s kubectl get nodes --no-headers | grep -c " Ready"
      register: ready_count
      changed_when: false
      failed_when: false
    
    - name: Cluster summary
      debug:
        msg: |
          ========================================
          K3s Cluster Status
          ========================================
          Ready Nodes: {{ ready_count.stdout }}
          
          {{ all_nodes.stdout }}
          ========================================
