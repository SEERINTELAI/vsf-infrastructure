---
# Deploy VSF Safety Constraints to K3s Cluster
# 
# Usage: ansible-playbook -i ../inventory/vsf.yml deploy-safety-constraints.yml
#
# This playbook deploys:
#   - vsf-workloads namespace
#   - ResourceQuota (CPU/Memory/GPU limits)
#   - LimitRange (per-pod/container caps)
#   - NetworkPolicy (isolation)

- name: Deploy VSF Safety Constraints
  hosts: k3s_control_plane[0]
  become: true
  vars:
    k8s_manifests_dir: "{{ playbook_dir }}/../../k8s/safety"
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  tasks:
    - name: Check cluster health
      command: kubectl --kubeconfig={{ kubeconfig }} cluster-info
      register: cluster_info
      changed_when: false

    - name: Display cluster info
      debug:
        msg: "{{ cluster_info.stdout_lines[:3] }}"

    - name: Create safety manifests directory on control plane
      file:
        path: /tmp/vsf-safety
        state: directory
        mode: '0755'

    - name: Copy safety manifests
      copy:
        src: "{{ k8s_manifests_dir }}/"
        dest: /tmp/vsf-safety/
        mode: '0644'

    - name: Apply safety constraints with kustomize
      command: kubectl --kubeconfig={{ kubeconfig }} apply -k /tmp/vsf-safety/
      register: apply_result
      changed_when: "'created' in apply_result.stdout or 'configured' in apply_result.stdout"

    - name: Display apply result
      debug:
        msg: "{{ apply_result.stdout_lines }}"

    - name: Verify namespace created
      command: kubectl --kubeconfig={{ kubeconfig }} get namespace vsf-workloads
      register: ns_check
      changed_when: false

    - name: Verify ResourceQuota
      command: kubectl --kubeconfig={{ kubeconfig }} get resourcequota -n vsf-workloads
      register: quota_check
      changed_when: false

    - name: Display ResourceQuota
      debug:
        msg: "{{ quota_check.stdout_lines }}"

    - name: Verify LimitRange
      command: kubectl --kubeconfig={{ kubeconfig }} get limitrange -n vsf-workloads
      register: limit_check
      changed_when: false

    - name: Display LimitRange
      debug:
        msg: "{{ limit_check.stdout_lines }}"

    - name: Cleanup temp files
      file:
        path: /tmp/vsf-safety
        state: absent

    - name: Summary
      debug:
        msg: |
          
          ============================================
          VSF Safety Constraints Deployed
          ============================================
          Namespace: vsf-workloads
          
          ResourceQuota:
            CPU: 160 cores (80% of 200)
            Memory: 850Gi (85% of 1TB)
            GPUs: 6 (reserve 2 for system)
            Pods: 100 max
          
          LimitRange:
            Per-Pod: max 4 CPU, 8Gi memory
            Per-Container: max 2 CPU, 4Gi memory, 1 GPU
          
          NetworkPolicy: Workload isolation enabled
          ============================================
